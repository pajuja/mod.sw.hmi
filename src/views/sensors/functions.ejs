var ON_OFF_SENSOR = "On/off sensor";

var currentlyProcessing = new Array();

function createNewSensor() {
	if ($("#new_sensor_agent_id").val() != "") {
		$.ajax({
			type: "GET",
			url: "./api/config",
			dataType: "json",
			success: function (data) {					
				var ngsiConnection = null;
				$(data).each(function(i, item) {							
					ngsiConnection = new NGSI.Connection("http://" + item.ocb_host + ":" + item.ocb_port, {
						ngsi_proxy_url: "http://" + item.ngsi_proxy_host + ":" + item.ngsi_proxy_port
					});
				})
				if (ngsiConnection != null) {
					ngsiConnection.v2.createEntity({
						"id": $("#new_sensor_agent_id").val(),
						"type": "SensorAgent",
						"sensorData": {
								"type": "array",
								"value": [
									{
										"type": "SensorDataEntry",
										"value": {
											"measurementType": {
												"type": "string",
												//"value": $("#new_sensor_measurement_type").val()
												"value": "-"
											},
											"modifiedTime": {
												"type": "string",
												"value": new Date().toISOString()
											},
											"readings": {
												"type": "array",
												"value": [													
												]
											},
											"sensorId": {
												"type": "string",
												//"value": $("#new_sensor_id").val()
												"value": $("#new_sensor_agent_id").val()  // IN ORDER FOR THE SENSOR DATA PAGE TO WORK PROPERLY
											},
											"sensorManufacturer": {
												"type": "string",
												//"value": $("#new_sensor_manufacturer").val()
												"value": "-"
											},
											"sensorType": {
												"type": "string",
												//"value": $("#new_sensor_type").val()
												"value": ON_OFF_SENSOR
											}
										}
									}
								]
							}
					}).then(
						(response) => {
							// Entity created successfully
							var onOffSensorHTML = "<tr id=\"onOffSensor_" + $("#new_sensor_agent_id").val() + "\">" + getOnOffSensorRowHTML($("#new_sensor_agent_id").val(), "", "", $("#new_sensor_agent_id").val(), ON_OFF_SENSOR, "") + "</tr>";
							$("#currentOnOffSensors").append(onOffSensorHTML);							
							$("#new_sensor_agent_id").val("");							
							//$("#new_sensor_measurement_type").val("");
							//$("#new_sensor_id").val("");
							//$("#new_sensor_manufacturer").val("");
							//$("#new_sensor_type").val("");							
							showAndDismissAlert("success", "New sensor created succesfully!", "sensorsAlert");
						}, (error) => {
							console.log(error);
							// Error creating the entity
							showAndDismissAlert("danger", "There was an error creating the sensor (" + error + ")!", "sensorsAlert");
						}
					);
				}
			}
		});
	} else {
		showAndDismissAlert("danger", "Id field is required.", "sensorsAlert");		
	}
}

function initSensors(ngsiConnection) {	

	ngsiConnection.v2.listEntities({type: "SensorAgent"}).then((response) => {
		var entities = response.results;
		$.each(entities, function(i, entity) {
			var sensorAgentId = entity.id;
			$.each(entity.sensorData.value, function(i, sensor) {				
				var sensorValue = false;
				var manufacturer = sensor.value.sensorManufacturer.value;
				var measurementType = sensor.value.measurementType.value;
				var sensorId = sensor.value.sensorId.value;
				var sensorType = sensor.value.sensorType.value;				
				if (sensorType == ON_OFF_SENSOR) {
					$.each(sensor.value.readings.value, function(i, sensorValue) {
						if (sensorValue.value.reading.type == "Boolean" || sensorValue.value.reading.type == "boolean") {
							sensorValue = sensorValue.value.reading.value;					
						}
					});
					var onOffSensorHTML = "<tr id=\"onOffSensor_" + sensorAgentId + "\">" + getOnOffSensorRowHTML(sensorAgentId) + "</tr>";
					$("#currentOnOffSensors").append(onOffSensorHTML);					
				}
			});
		});
	});			
	$('#currentOnOffSensors').on('click', 'input[type=button]', function(e) {
		var sensorAgentId = this.id.substr("onOffSensorButton_".length);				
		if (currentlyProcessing.indexOf(sensorAgentId) != -1) {
			return;
		} else {
			currentlyProcessing.push(sensorAgentId);
		
			// first send true
			ngsiConnection.v2.replaceEntityAttributeValue({
				id: sensorAgentId,
				attribute: "sensorData",
				value: [
					{
						"type": "SensorDataEntry",
						"value": {
							"measurementType": {
								"type": "string",
								"value": "-"
							},
							"modifiedTime": {
								"type": "string",
								"value": new Date().toISOString()
							},
							"readings": {
								"type": "array",
								"value": [
									{
										"type": "SensorReading",
										"value": {
											"reading": {
												"type": "boolean",
												"value": true
											}
										}
									}
								]
							},
							"sensorId": {
								"type": "string",
								"value": sensorAgentId
							},
							"sensorManufacturer": {
								"type": "string",
								"value": "-"
							},
							"sensorType": {
								"type": "string",
								"value": ON_OFF_SENSOR
							}
						}
					}
				]
			}).then(
				(response) => {				
					// then send false:
					ngsiConnection.v2.replaceEntityAttributeValue({
						id: sensorAgentId,
						attribute: "sensorData",
						value: [
							{
								"type": "SensorDataEntry",
								"value": {
									"measurementType": {
										"type": "string",
										"value": "-"
									},
									"modifiedTime": {
										"type": "string",
										"value": new Date().toISOString()
									},
									"readings": {
										"type": "array",
										"value": [
											{
												"type": "SensorReading",
												"value": {
													"reading": {
														"type": "boolean",
														"value": false
													}
												}
											}
										]
									},
									"sensorId": {
										"type": "string",
										"value": sensorAgentId
									},
									"sensorManufacturer": {
										"type": "string",
										"value": "-"
									},
									"sensorType": {
										"type": "string",
										"value": ON_OFF_SENSOR
									}
								}
							}
						]
					}).then(
						(response) => {
							currentlyProcessing = jQuery.grep(currentlyProcessing, function(value) {
								return value != sensorAgentId;
							});
							// Entity value replaced successfully
							// response.value entity value
							// response.correlator transaction id associated with the server response
						}, (error) => {
							// Error replacing attribute value
							// If the error was reported by Orion, error.correlator will be
							// filled with the associated transaction id
						}
					);				
					
				}, (error) => {
					// Error replacing attribute value
					// If the error was reported by Orion, error.correlator will be
					// filled with the associated transaction id
				}
			);
		}
    });
	
	$('#currentOnOffSensors').on('click', 'a.removeOnOffSensorButton', function(e) {	
		event.stopPropagation();
		if (confirm("Are you sure you want to delete?")) {
			var sensorAgentId = this.id.substr("removeOnOffSensorButton_".length)
			ngsiConnection.v2.deleteEntity(sensorAgentId).then(
				(response) => {
					$("#onOffSensor_" + sensorAgentId).remove();
					// Entity deleted successfully
					// response.correlator transaction id associated with the server response
					showAndDismissAlert("success", "On/off sensor deleted succesfully!", "sensorsAlert");
				}, (error) => {
					// Error deleting the entity
					// If the error was reported by Orion, error.correlator will be
					// filled with the associated transaction id
					showAndDismissAlert("error", "There was an error deleting the on/off sensor: " + error + "!", "sensorsAlert");
				}
			);
		} else {}       
		event.preventDefault();
	});
	
}

function updateSensors(notification) {						
	//console.log("Received notification: " + JSON.stringify(notification));					   
	$.each(notification.data, function () {
		var sensorAgentId = this.id;
		$.each(this.sensorData.value, function () {							
			if (this.value.sensorType.value == ON_OFF_SENSOR) {
				var onOffSensorHTML = getOnOffSensorRowHTML(sensorAgentId);
				if ($("#onOffSensor_" + sensorAgentId).length) {
					$("#onOffSensor_" + sensorAgentId).html(onOffSensorHTML);
				} else {
					$("#currentOnOffSensors").append("<tr id=\"onOffSensor_" + sensorAgentId + "\">" + onOffSensorHTML + "</tr>");
				}	
			}
		});
	});	
}

function getOnOffSensorRowHTML(sensorAgentId) {
	//return "<td>" + sensorAgentId + "</td><td>" + manufacturer + "</td><td>" + measurementType + "</td><td>" + sensorId + "</td><td>" + sensorType + "</td><td><input id=\"booleanToggle_" + sensorAgentId + "_" + sensorId + "\" class=\"booleanToggle\" type=\"checkbox\" " + checked + "></td>";
	//return "<td>" + sensorAgentId + "</td><td><input id=\"booleanToggle_" + sensorAgentId + "\" class=\"booleanToggle\" type=\"checkbox\" " + checked + "></td>";
	var htmlStr = "<td><input type=\"button\" id=\"onOffSensorButton_" + sensorAgentId + "\" value=\"" + sensorAgentId + "\"></input>";
	<% if (user && user.role == "admin") { %> 
		htmlStr += "&nbsp;(<a id=\"removeOnOffSensorButton_" + sensorAgentId + "\" class=\"removeOnOffSensorButton\" href=\"#\">delete</a>)";
	<% } %>
	htmlStr += "</td>";
	return htmlStr;
}