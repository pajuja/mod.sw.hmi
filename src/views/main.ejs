<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		<meta name="description" content="">
		<meta name="author" content="">

		<title>HMI</title>

		<link rel="stylesheet" href="/css/bootstrap.min.css">
		<!-- Optional theme -->
        <link rel="stylesheet" href="/css/bootstrap-theme.min.css">	
        <link rel="stylesheet" href="/css/style.css">			
        <link rel="stylesheet" href="/css/bootstrap-toggle.min.css">			


		<script src="/js/NGSI.js"></script> 
		<script src="/js/jquery-3.3.1.min.js"></script> 		
		<script src="/js/bootstrap.min.js"></script> 	
		<script src="/js/bootbox.min.js"></script> 			
		<script src="/js/Chart.bundle.min.js"></script>
		<script src="/js/bootstrap-toggle.min.js"></script>
		<script src="/js/hammer.min.js"></script>		
		<script src="/js/chartjs-plugin-streaming.js"></script>		
		<script src="/js/chartjs-plugin-zoom.min.js"></script>
		<script>
		
			var floorPlanImage;
			var floorPlanImageScale = 1;
			var floorPlanImageToWebPageScale = 1;
			var floorPlanImageXOffset = 0;
			var floorPlanImageYOffset = 0;
		
			var ocb_host = <%- '"' + ocb_host + '"' %>;	
			var ocb_port = <%- '"' + ocb_port + '"' %>;	
			var ngsi_proxy_host = <%- '"' + ngsi_proxy_host + '"' %>;	
			var ngsi_proxy_port = <%- '"' + ngsi_proxy_port + '"' %>;		
		
			$(document).ready(function() {
				
				startSubscriptions();
			
				$('#spOnOff').change(function() {
					updateSPGraphOnCanvas();
				});
						
				$("#sendTaskSpecification").click(function() {
					sendTaskSpecification();
					return false;
				});			
				
				<% if (user && user.role == "admin") { %>
				$("#createNewSensor").click(function() {
					createNewSensor();
					return false;
				});
				<% } %>
			});
			
			function startSubscriptions() {
				var ngsiConnection = null;
				if (ocb_host != "" && ocb_port != "" && ngsi_proxy_host != "" && ngsi_proxy_port != "") {
					ngsiConnection = new NGSI.Connection("http://" + ocb_host + ":" + ocb_port, {
						ngsi_proxy_url: "http://" + ngsi_proxy_host + ":" + ngsi_proxy_port
					});
					ngsiConnection.getServerDetails().then(
					(response) => {
					}, (error) => {
						$("#generalAlert").html("<div class=\"alert alert-warning\" style=\"margin-top:10px\">Error. Cannot connect to OCB.<% if (user && user.role == "admin") { %> Check configuration.<% } %></div>");
					});										
				} else {
					$("#generalAlert").html("<div class=\"alert alert-warning\" style=\"margin-top:10px\">Error. Cannot connect to OCB.<% if (user && user.role == "admin") { %> Check configuration.<% } %></div>");				
				}
				if (ngsiConnection == null) {
					$("#generalAlert").html("<div class=\"alert alert-warning\" style=\"margin-top:10px\">Error. OCB is not configured.<% if (user && user.role == "admin") { %> Configure OCB in System Settings.<% } %></div>");
				} else {
					$.ajax({
						type: "GET",
						url: "./api/fp",
						dataType: "json",
						success: function (data) {					
							var created = "";
							var imgURL = "";
							var name = "";
							var xoffset = "";
							var yoffset = "";
							$(data).each(function(i, item) {						
								if (item.created > created) {						
									created = item.created;
									imgURL = item.imgurl;
									name = item.name;
									floorPlanImageScale = item.scale;
									floorPlanImageXOffset = item.xoffset;
									floorPlanImageYOffset = item.yoffset;
								}						
							})
							if (imgURL != "") {
								floorPlanImage = new Image();
								floorPlanImage.onload = function() {		
									drawImageOnCanvas(floorPlanImage, "#overviewFloorplan");	
									drawImageOnCanvas(floorPlanImage, "#floorplan");
									$("#floorplanInfo").html("<p><strong>floor plan:</strong> " + name + ", <strong>scale:</strong> " + floorPlanImageScale + " m/px, <strong>x-offset:</strong> " + floorPlanImageXOffset + " px, <strong>y-offset:</strong> " + floorPlanImageYOffset + " px</p>");
								};
								floorPlanImage.src = imgURL;	
							}
													
							if (ngsiConnection != null) {
					
								/* INITIALIZATIONS */				
								initSensingAndPerception(ngsiConnection);
								initTaskSpecifications(ngsiConnection);						    
								initCurrentTasks(ngsiConnection);										
								initRobotsTable(ngsiConnection);									
								initSensors(ngsiConnection);	
								initSensorData(ngsiConnection);		
								<% if (user && user.role == "admin") { %>
									initUsers();
								<% } %>

								/* SUBSCRIPTIONS */
								ngsiConnection.v2.createSubscription({
									"description": "Updating task specifications",
									"subject": { "entities": [ { "idPattern": ".*", "type": "TaskSpecState" } ] },
									"notification": {
										"callback": function (notification) {				   
											updateTaskSpecifications(notification);
										}
									},
									//"expires": "2040-04-05T14:00:00.00Z",
									//"throttling": 5
								}).then(
									(response) => {
										//console.log("Created subscription: " + JSON.stringify(response));
										$.ajax({
											url: "./api/subscription",
											type: "POST",
											data: {
												"subs_id": response.subscription.id
											}
										}).done(function(data) {
										}).fail(function(xhr, status, err) {
											showAndDismissAlert("danger", xhr.responseText, "usersAlert");				
										});			
									}, (error) => {
										//console.log(error);
									}
								);		

								ngsiConnection.v2.createSubscription({
									"description": "Updating current tasks",
									"subject": { "entities": [ { "idPattern": ".*", "type": "taskSet" } ] },
									"notification": {
										"callback": function (notification) {				   
											updateCurrentTasks(notification);
										}
									},
									//"expires": "2040-04-05T14:00:00.00Z",
									//"throttling": 5
								}).then(
									(response) => {
										//console.log("Created subscription: " + JSON.stringify(response));
										$.ajax({
											url: "./api/subscription",
											type: "POST",
											data: {
												"subs_id": response.subscription.id
											}
										}).done(function(data) {
										}).fail(function(xhr, status, err) {
											showAndDismissAlert("danger", xhr.responseText, "usersAlert");				
										});	
									}, (error) => {
										//console.log(error);
									}
								);										
								
								ngsiConnection.v2.createSubscription({
									"description": "Updating ongoing tasks",
									"subject": { "entities": [ { "idPattern": ".*", "type": "Task" } ] },
									"notification": {
										"callback": function (notification) {				   
											updateOngoingTasks(notification);
										}
									},
									//"expires": "2040-04-05T14:00:00.00Z",
									//"throttling": 5
								}).then(
									(response) => {
										//console.log("Created subscription: " + JSON.stringify(response));
										$.ajax({
											url: "./api/subscription",
											type: "POST",
											data: {
												"subs_id": response.subscription.id
											}
										}).done(function(data) {
										}).fail(function(xhr, status, err) {
											showAndDismissAlert("danger", xhr.responseText, "usersAlert");				
										});											
									}, (error) => {
										//console.log(error);
									}
								);										
								
								ngsiConnection.v2.createSubscription({
									"description": "Updating robot data",
									"subject": { "entities": [ { "idPattern": ".*", "type": "ROBOT" } ], "condition": { "attrs": [ "position_channel" ] } },
									"notification": {
										"callback": function (notification) {
											updateRobotsOnOverview(notification);
											updateRobotsTable(notification);
									   },
									   "attrs": [ "position_channel" ]
									},
									//"expires": "2040-04-05T14:00:00.00Z",
									//"throttling": 5
								}).then(
									(response) => {
										//console.log("Created subscription: " + JSON.stringify(response));
										$.ajax({
											url: "./api/subscription",
											type: "POST",
											data: {
												"subs_id": response.subscription.id
											}
										}).done(function(data) {
										}).fail(function(xhr, status, err) {
											showAndDismissAlert("danger", xhr.responseText, "usersAlert");				
										});											
									}, (error) => {
										//console.log(error);
									}
								);
								
								ngsiConnection.v2.createSubscription({
									"description": "Updating sensor data",
									"subject": { "entities": [ { "idPattern": ".*", "type": "SensorAgent" } ] },
									"notification": {
										"callback": function (notification) {
											updateSensorsOnOverview(notification);
											updateSensors(notification);	
											updateSensorData(notification);					
										}
									},
									//"expires": "2040-04-05T14:00:00.00Z",
									//"throttling": 5
								}).then(
									(response) => {
										//console.log("Created subscription: " + JSON.stringify(response));
										$.ajax({
											url: "./api/subscription",
											type: "POST",
											data: {
												"subs_id": response.subscription.id
											}
										}).done(function(data) {
										}).fail(function(xhr, status, err) {
											showAndDismissAlert("danger", xhr.responseText, "usersAlert");				
										});											
									}, (error) => {
										//console.log(error);
									}
								);							
							}
						}
					});
				}
			}
			
			<% include ./generalFunctions.ejs %>			
			<% include ./sp/functions.ejs %>				
			<% include ./overview/functions.ejs %>		
			<% include ./floorplan/functions.ejs %>		
			<% include ./task_management/functions.ejs %>
			<% include ./robots/functions.ejs %>
			<% include ./sensors/functions.ejs %>				
			<% include ./sensor_data/functions.ejs %>		
			<% if (user && user.role == "admin") { %>	
				<% include ./user_management/functions.ejs %>
			<% } %>		
		</script>
	
	</head>

	<body>
		<div class="container">
			<div class="page-header">
				<div class="pull-left">
					<!--<img height=55 src="/img/logo.png">-->
				</div>
				<div class="pull-right">
					<div class="pull-right" style="font-size:10px">HMI version&nbsp;<%= version %></div>
					<form action="/logout" method="post">
						<button class="btn btn-default btn-sm" style=" margin-top:10px;" disabled>Logged in as <%= user.name %>&nbsp;</button>&nbsp;<button type="submit" class="btn btn-default btn-sm" style=" margin-top:10px;"><%= __("logout") %></button>
					</form>
				</div>
				<div class="clearfix"></div>
			</div>					
			<div id="generalAlert"></div>
			<ul class="nav nav-tabs" style=" margin-top:10px;" role="tablist">
				<li class="active"><a href="#overviewTab" role="tab" data-toggle="tab">Overview</a></li>
				<li><a href="#floorplansTab" role="tab" data-toggle="tab">Floor Plan Management</a></li>	
				<li><a href="#taskManagementTab" role="tab" data-toggle="tab">Task Management</a></li>						
				<li><a href="#robotsTab" role="tab" data-toggle="tab">Robots</a></li>
				<li><a href="#sensorsTab" role="tab" data-toggle="tab">Control</a></li>				
				<li><a href="#sensorDataTab" role="tab" data-toggle="tab">Sensor Data</a></li>			
				<% if (user && user.role == "admin") { %>  
				<li><a href="#usersTab" role="tab" data-toggle="tab">User Management</a></li>
				<% } %>
			</ul>
			<div class="tab-content">
				<div class="tab-pane active" id="overviewTab" style="margin-top:10px;">
					<% include ./overview/tabContent.ejs %>					
				</div>
				<div class="tab-pane" id="floorplansTab" style="margin-top:10px;">
					<% include ./floorplan/tabContent.ejs %>
				</div>
				<div class="tab-pane" id="taskManagementTab" style="margin-top:0px;">
					<% include ./task_management/tabContent.ejs %>				
				</div>			
				<div class="tab-pane" id="robotsTab" style="margin-top:-10px;">
					<% include ./robots/tabContent.ejs %>			
				</div>						
				<div class="tab-pane" id="sensorsTab" style="margin-top:10px;">
					<% include ./sensors/tabContent.ejs %>
				</div> 					
				<div class="tab-pane" id="sensorDataTab" style="margin-top:10px;">
					<% include ./sensor_data/tabContent.ejs %>
				</div> 			
				<% if (user && user.role == "admin") { %>  			
					<div class="tab-pane" id="usersTab" style="margin-top:0px;">
						<% include ./user_management/tabContent.ejs %>
					</div>
                <% } %>				
			</div>	
		</div>
	</body>
</html>
